<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Blog/View/Feed.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE ImplicitParams #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Blog</span><span class='hs-varop'>.</span><span class='hs-conid'>View</span><span class='hs-varop'>.</span><span class='hs-conid'>Feed</span> <span class='hs-keyword'>where</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Blog</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<a name="line-6"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Blog</span><span class='hs-varop'>.</span><span class='hs-conid'>Util</span>
<a name="line-7"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Blog</span><span class='hs-varop'>.</span><span class='hs-conid'>View</span>
<a name="line-8"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>DublinCore</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<a name="line-9"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>RSS</span><span class='hs-varop'>.</span><span class='hs-conid'>Syntax</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span>             <span class='hs-keyword'>as</span> <span class='hs-conid'>T</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>XML</span><span class='hs-varop'>.</span><span class='hs-conid'>Light</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>  <span class='hs-keyword'>as</span> <span class='hs-conid'>X</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-comment'>-- feedRss :: (?config :: Config) =&gt; [Entry] -&gt; UTCTime -&gt; RSS</span>
<a name="line-14"></a><span class='hs-comment'>-- feedRss entries now = (nullRSS feedTitle feedLink)</span>
<a name="line-15"></a><span class='hs-comment'>--   { rssChannel = channel</span>
<a name="line-16"></a><span class='hs-comment'>--   , rssAttrs   = [dcSpec]</span>
<a name="line-17"></a><span class='hs-comment'>--   }</span>
<a name="line-18"></a><span class='hs-comment'>--   where</span>
<a name="line-19"></a><span class='hs-comment'>--     channel = (nullChannel feedTitle feedLink)</span>
<a name="line-20"></a><span class='hs-comment'>--       { rssDescription   = feedDescription</span>
<a name="line-21"></a><span class='hs-comment'>--       , rssLanguage      = Just "en"</span>
<a name="line-22"></a><span class='hs-comment'>--       , rssCopyright     = Just copyright</span>
<a name="line-23"></a><span class='hs-comment'>--       , rssEditor        = Just feedAuthor</span>
<a name="line-24"></a><span class='hs-comment'>--       , rssWebMaster     = Just feedAuthor</span>
<a name="line-25"></a><span class='hs-comment'>--       , rssLastUpdate    = Just $ formatDateRfc feedBuildDate</span>
<a name="line-26"></a><span class='hs-comment'>--       -- , rssCategories =</span>
<a name="line-27"></a><span class='hs-comment'>--       , rssGenerator     = Just "feed-0.3.9.1 (Sigbjorn Finne)"</span>
<a name="line-28"></a><span class='hs-comment'>--       , rssItems         = map rssItem entryInfos</span>
<a name="line-29"></a><span class='hs-comment'>--       , rssChannelOther  = map dcItemToXml dcData</span>
<a name="line-30"></a><span class='hs-comment'>--       , rssImage         = Just siteLogo</span>
<a name="line-31"></a><span class='hs-comment'>--       }</span>
<a name="line-32"></a><span class='hs-comment'>--     dcData =</span>
<a name="line-33"></a><span class='hs-comment'>--       [ DCItem DC_Creator feedAuthorName</span>
<a name="line-34"></a><span class='hs-comment'>--       , DCItem DC_Language "en"</span>
<a name="line-35"></a><span class='hs-comment'>--       , DCItem DC_Rights copyright</span>
<a name="line-36"></a><span class='hs-comment'>--       , DCItem DC_Date $ formatDateIso feedBuildDate</span>
<a name="line-37"></a><span class='hs-comment'>--       , DCItem DC_Description feedDescription</span>
<a name="line-38"></a><span class='hs-comment'>--       ]</span>
<a name="line-39"></a><span class='hs-comment'>--     siteDataString r = T.unpack $ r siteData</span>
<a name="line-40"></a><span class='hs-comment'>--     makeUrl          = T.unpack . renderUrl'</span>
<a name="line-41"></a><span class='hs-comment'>--     formatDateRfc    =</span>
<a name="line-42"></a><span class='hs-comment'>--       formatTime defaultTimeLocale rfc822DateFormat . fromJust</span>
<a name="line-43"></a><span class='hs-comment'>--     formatDateIso d  =</span>
<a name="line-44"></a><span class='hs-comment'>--       formatTime defaultTimeLocale (iso8601DateFormat Nothing) $ fromJust d</span>
<a name="line-45"></a><span class='hs-comment'>--     feedTitle        = siteDataString siteDataTitle ++ " â€” Entries"</span>
<a name="line-46"></a><span class='hs-comment'>--     feedLink         = makeUrl ""</span>
<a name="line-47"></a><span class='hs-comment'>--     feedDescription  = siteDataString siteDataDescription</span>
<a name="line-48"></a><span class='hs-comment'>--     feedBuildDate    = Just now</span>
<a name="line-49"></a><span class='hs-comment'>--     feedAuthorEmail  = siteDataString (authorInfoEmail . siteDataAuthorInfo)</span>
<a name="line-50"></a><span class='hs-comment'>--     feedAuthorName   = siteDataString (authorInfoName . siteDataAuthorInfo)</span>
<a name="line-51"></a><span class='hs-comment'>--     feedAuthor       = concat [feedAuthorEmail, " (", feedAuthorName, ")"]</span>
<a name="line-52"></a><span class='hs-comment'>--     copyright        = T.unpack $ T.append "Copyright " $ siteDataCopyright siteData</span>
<a name="line-53"></a><span class='hs-comment'>--     rssItem (eEntity@(D.Entity _ entry), (entryUrl, tags)) =</span>
<a name="line-54"></a><span class='hs-comment'>--       (nullItem $ T.unpack $ entryTitle entry)</span>
<a name="line-55"></a><span class='hs-comment'>--         { rssItemLink        = Just $ makeUrl entryUrl</span>
<a name="line-56"></a><span class='hs-comment'>--         , rssItemDescription = Just $ B.renderHtml $ entryHtml entry</span>
<a name="line-57"></a><span class='hs-comment'>--         -- , rssItemAuthor   = Just feedAuthorName</span>
<a name="line-58"></a><span class='hs-comment'>--         , rssItemCategories  = map rssCategory tags</span>
<a name="line-59"></a><span class='hs-comment'>--         , rssItemGuid        = Just $ RSSGuid (Just True) [] $ makeUrl $ entryPermalink eEntity</span>
<a name="line-60"></a><span class='hs-comment'>--         , rssItemPubDate     = Just $ formatDateRfc $ entryPostedAt entry</span>
<a name="line-61"></a><span class='hs-comment'>--         , rssItemOther       = map dcItemToXml dcItemData</span>
<a name="line-62"></a><span class='hs-comment'>--         }</span>
<a name="line-63"></a><span class='hs-comment'>--       where</span>
<a name="line-64"></a><span class='hs-comment'>--         dcItemData =</span>
<a name="line-65"></a><span class='hs-comment'>--           [ DCItem DC_Creator feedAuthorName</span>
<a name="line-66"></a><span class='hs-comment'>--           , DCItem DC_Date $ formatDateIso $ entryPostedAt entry</span>
<a name="line-67"></a><span class='hs-comment'>--           , DCItem DC_Subject $ T.unpack $ T.intercalate ", " $ map tagLabel tags</span>
<a name="line-68"></a><span class='hs-comment'>--           ]</span>
<a name="line-69"></a><span class='hs-comment'>--     rssCategory tag = RSSCategory</span>
<a name="line-70"></a><span class='hs-comment'>--       Nothing</span>
<a name="line-71"></a><span class='hs-comment'>--       [] $</span>
<a name="line-72"></a><span class='hs-comment'>--       T.unpack $ tagLabel tag</span>
<a name="line-73"></a><span class='hs-comment'>--     dcSpec = X.Attr</span>
<a name="line-74"></a><span class='hs-comment'>--       (X.QName "dc" Nothing (Just "xmlns"))</span>
<a name="line-75"></a><span class='hs-comment'>--       "<a href="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</a>"</span>
<a name="line-76"></a><span class='hs-comment'>--     siteLogo =</span>
<a name="line-77"></a><span class='hs-comment'>--       nullImage</span>
<a name="line-78"></a><span class='hs-comment'>--         ( T.unpack . renderUrl'</span>
<a name="line-79"></a><span class='hs-comment'>--         . T.append (hostConfigHost (siteDataHostConfig siteData))</span>
<a name="line-80"></a><span class='hs-comment'>--         $ "/img/site_logo.jpg" )</span>
<a name="line-81"></a><span class='hs-comment'>--         ( T.unpack $ siteDataTitle siteData )</span>
<a name="line-82"></a><span class='hs-comment'>--         ( T.unpack . renderUrl . hostConfigHost</span>
<a name="line-83"></a><span class='hs-comment'>--         $ siteDataHostConfig siteData )</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-comment'>-- dcItemToXml :: DCItem -&gt; X.Element</span>
<a name="line-86"></a><span class='hs-comment'>-- dcItemToXml dcItem = X.Element eName [] [item] Nothing</span>
<a name="line-87"></a><span class='hs-comment'>--   where</span>
<a name="line-88"></a><span class='hs-comment'>--     eName = X.QName (infoToTag $ dcElt dcItem) Nothing (Just "dc")</span>
<a name="line-89"></a><span class='hs-comment'>--     item = X.Text $ X.CData X.CDataText (dcText dcItem) Nothing</span>
</pre></body>
</html>
